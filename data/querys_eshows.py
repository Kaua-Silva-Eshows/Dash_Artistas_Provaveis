from data.dbconnect import get_dataframe_from_query
import streamlit as st

@st.cache_data
def rank_likely_artists(day, day2, filters='', id_group=''):
    return get_dataframe_from_query(f""" 

SELECT *
FROM (
  SELECT
    C.ID AS 'ID Estabelecimento',
    C.NAME AS 'Estabelecimento',
    GC.ID AS 'ID GRUPO',
    O.ID AS ID_OPORTUNIDADE,
    O.DATA_INICIO AS 'Início',
    O.DATA_FIM AS 'Fim',
    A.ID AS 'ID Artista',
    A.NOME AS 'Artista',
    A.CELULAR AS 'TEL',
    CASE WHEN F.FAVORITE = '01' THEN 'SIM' ELSE 'NÃO' END AS 'Favorito',
    
    COUNT(DISTINCT P.ID) AS 'Num Shows',
    
    EM.DESCRICAO AS 'Estilo',
    AGG.NUM_SHOWS AS 'Shows Outras Casas Grupo',
    AGG.QTD_CASAS AS 'Casas do Grupo',
    AGG.ULTIMA_DATA AS 'Ultimo Shows no Grupo',

    (
      (CASE WHEN F.FAVORITE = '01' THEN 1 ELSE 0 END) +  
      (COUNT(DISTINCT P.ID) / 10) +  
      (AGG.QTD_CASAS / 2) +
      (DATEDIFF(CURRENT_DATE, AGG.ULTIMA_DATA) / 365)
    ) AS PONTUACAO,

    ROW_NUMBER() OVER (PARTITION BY O.ID ORDER BY 
      (CASE WHEN F.FAVORITE = '01' THEN 1 ELSE 0 END) +  
      (COUNT(DISTINCT P.ID) / 10) +  
      (AGG.QTD_CASAS / 2) +
      (DATEDIFF(CURRENT_DATE, AGG.ULTIMA_DATA) / 365)
    DESC) AS RN

  FROM T_OPORTUNIDADES O
  JOIN T_ATRACOES A ON (
    A.FK_ESTILO_PRINCIPAL IN (
      O.FK_ESTILO_INTERESSE_1,
      O.FK_ESTILO_INTERESSE_2,
      O.FK_ESTILO_INTERESSE_3
    )
  )
  LEFT JOIN T_ESTILOS_MUSICAIS EM ON EM.ID = A.FK_ESTILO_PRINCIPAL
  LEFT JOIN T_COMPANIES C ON C.ID = O.FK_CONTRATANTE
  LEFT JOIN T_FAVORITO F ON A.ID = F.FK_ATRACAO AND F.FK_CONTRATANTE = C.ID
  LEFT JOIN T_GRUPOS_DE_CLIENTES GC ON GC.ID = C.FK_GRUPO
  LEFT JOIN T_PROPOSTAS P ON P.FK_CONTRATADO = A.ID


  LEFT JOIN (
    SELECT 
      P2.FK_CONTRATADO,
      COUNT(DISTINCT P2.ID) AS NUM_SHOWS,
      COUNT(DISTINCT C2.ID) AS QTD_CASAS,
      MAX(P2.DATA_INICIO) AS ULTIMA_DATA
    FROM T_ATRACOES A2
    LEFT JOIN T_PROPOSTAS P2 ON A2.ID = P2.FK_CONTRATADO
    LEFT JOIN T_COMPANIES C2 ON C2.ID = P2.FK_CONTRANTE
    WHERE P2.DATA_INICIO < CURDATE()
    AND (
      NULLIF('{id_group}', '') IS NULL OR C2.FK_GRUPO = '{id_group}'
    )
    GROUP BY P2.FK_CONTRATADO 
  ) AGG ON AGG.FK_CONTRATADO = A.ID

  WHERE O.FK_STATUS_OPORTUNIDADE IN ('101')
    {filters}
    AND O.FK_CONTRATANTE IS NOT NULL
    AND NOT EXISTS (
      SELECT 1
      FROM T_PROPOSTAS P
      WHERE P.FK_CONTRATADO = A.ID
        AND P.FK_STATUS_PROPOSTA = '103'
        AND (
          (P.DATA_INICIO <= O.DATA_INICIO AND P.DATA_FIM > O.DATA_INICIO) OR
          (P.DATA_INICIO < O.DATA_FIM AND P.DATA_FIM >= O.DATA_FIM) OR
          (P.DATA_INICIO >= O.DATA_INICIO AND P.DATA_FIM <= O.DATA_FIM)
        )
    )
    AND DATE(O.DATA_INICIO) BETWEEN '{day}' AND '{day2}'

  GROUP BY 
    C.ID, C.NAME, GC.ID, O.ID, O.DATA_INICIO, O.DATA_FIM,
    A.ID, A.NOME, A.CELULAR, F.FAVORITE, EM.DESCRICAO,
    AGG.NUM_SHOWS, AGG.QTD_CASAS, AGG.ULTIMA_DATA
) SUB
WHERE PONTUACAO > 0
  AND RN <= 50
ORDER BY ID_OPORTUNIDADE, PONTUACAO DESC;
""")
